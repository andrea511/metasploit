jQueryInWindow ($) ->
  QUICK_PENTEST_URL = '/wizards/quick_pentest/form/'

  class @QuickPentestModal extends @TabbedModalView
    _modelsToTabs: {
      # transition map to figure out which tab a nested model is on. e.g.:
      workspace: 0,
      import: 1,
      scan_task: 1,
      nexpose_task: 1,
      exploit_task: 2,
      report: 3
    }

    initialize: ->
      super
      @setTitle 'Quick PenTest'
      @setDescription 'Set up a test that automatically gathers '+
                      'information about the target network, launches attacks '+
                      'against the targets, and builds a report of test findings.'
      @setTabs [
        {name: 'Target Settings'},
        {name: 'Configure Scan'},
        {name: 'Run Exploits', checkbox: true},
        {name: 'Generate Report', checkbox: true}
      ]
      @setButtons [
        {name: 'Cancel', class: 'close'},
        {name: 'Start Scan', class: 'btn primary'}
      ]
      @loadForm(QUICK_PENTEST_URL)

    events: _.extend({
      'click input#tab_run_exploits': 'toggleExploits',
      'click input#tab_generate_report': 'toggleGenerateReport',
      'click a.exclude_toggle': 'toggleExcludeIPs',
      'change input[name="quick_pentest[scan_type]"]': 'scanTypeChanged',
      'click #profile-button-menu li a': 'profileButtonPressed',
    }, TabbedModalView.prototype.events)

    getProfileMenu: => $("#profile-button-menu", @$modal)

    resetAllProfileButtons: =>
      $menu = @getProfileMenu()
      $('span.img, li, a.btn', $menu).removeClass('selected')

    selectProfileButtonAtIndex: (idx) =>
      # ugh. my css does not help us here. todo: add a .selected class to the li
      $menu = @getProfileMenu()
      $li = $('ul>li', $menu).eq(idx)
      $li.add($('span.img, a.btn', $li)).addClass('selected')

    profileButtonPressed: (e) =>
      e.preventDefault()
      @resetAllProfileButtons()
      $li = $(e.currentTarget).parents('li').first()
      @selectProfileButtonAtIndex($li.index())

    toggleExploits: (e) =>
      return unless $(e.currentTarget).parents('li').first().hasClass('selected')
      checked = $(e.currentTarget).is(':checked')
      $('.configure_exploits h3.enabled>span', @$modal).removeClass('disabled enabled')
      if checked
        $('.configure_exploits h3.enabled>span', @$modal).text("enabled").addClass('enabled')
        # toggle input value for exploit_enabled (hidden)
        $("[name='quick_pentest[exploit_enabled]']", @$modal).attr('value', '1')
      else
        $('.configure_exploits h3.enabled>span', @$modal).text("disabled").addClass('disabled')
        # toggle input value for exploit_enabled (hidden)
        $("[name='quick_pentest[exploit_enabled]']", @$modal).removeAttr('value')

    # checkbox on tab for report generation
    toggleGenerateReport: (e) =>
      return unless $(e.currentTarget).parents('li').first().hasClass('selected')
      checked = $(e.currentTarget).is(':checked')
      $('.generate_report h3.enabled>span', @$modal).removeClass('disabled enabled')
      if checked
        $('.generate_report h3.enabled>span', @$modal).text("enabled").addClass('enabled')
        # toggle input value for report_enabled (hidden)
        $("[name='quick_pentest[report_enabled]']", @$modal).attr('value', '1')
      else
        $('.generate_report h3.enabled>span', @$modal).text("disabled").addClass('disabled')
        # toggle input value for report_enabled (hidden)
        $("[name='quick_pentest[report_enabled]']", @$modal).removeAttr('value')

    # user clicks Exclude IP Addresses...
    toggleExcludeIPs: (e) =>
      e.preventDefault()
      $('.excluded_addresses', @$modal).show()
      $('.exclude_toggle_wrap', @$modal).hide()
      $('.create_project .advanced', @$modal).css(top: '-26px')

    # user toggles between Regular Scan, Nexpose Scan, and Import
    scanTypeChanged: (e) =>
      toggle_divs = ['toggle_regular_scan', 'toggle_import']
      _.each toggle_divs, (div) -> $(".#{div}", @$modal).hide()
      $(".toggle_#{$(e.target).val()}", @$modal).show()

    submitUrl: => QUICK_PENTEST_URL

    submitFormAjax: =>
      # populate our "profile" input with whatever the user has selected
      $menu = @getProfileMenu()
      name = $('ul>li.selected', $menu).attr('name')
      $('[name="quick_pentest[profile]"]', @$modal).val(name)
      super

    # we load the form from the wicked quick_pentest_controller route
    formLoadedSuccessfully: (html) =>
      return unless @content().is(':visible')
      super
      # toggle checkbox in tab depending on this value
      if $("[name='quick_pentest[report_enabled]']", @$modal).val() == "true"
        $("#tab_generate_report", @$modal).prop('checked', true)
      if $("[name='quick_pentest[exploit_enabled]']", @$modal).val() == "true"
        $("#tab_run_exploits", @$modal).prop('checked', true)
      # only show the first div
      $('form.quick_pentest>div.page', @$el).hide().first().show()
      #$('form#new_quick_pentest', @$modal).removeClass('formtastic')
      # select the first profile, because fuck it
      @selectProfileButtonAtIndex(0)
