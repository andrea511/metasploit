module MetasploitDataModels::AutomaticExploitation::Run::Decorator
  extend ActiveSupport::Concern

  included do

    #
    # ASSOCIATIONS
    #

    belongs_to :match_set, class_name: "MetasploitDataModels::AutomaticExploitation::MatchSet"
    has_many :exceptions, class_name: '::Nexpose::Result::Exception', through: :match_results, source: :nexpose_exceptions
    has_many :validations, class_name: '::Nexpose::Result::Validation', through: :match_results, source: :nexpose_validations

    #
    # State Machine
    #

    state_machine :state, initial: :not_yet_started do
      event :start do
        transition [:not_yet_started] => :running
      end

      event :finish do
        transition [:running] => :finished
      end

      event :error_out do
        transition [:running] => :failed
      end
    end

    def self.configure_run(user,workspace)
      automatic_exploitation_run           = MetasploitDataModels::AutomaticExploitation::Run.new
      automatic_exploitation_run.workspace = workspace
      automatic_exploitation_run.user      = user
      automatic_exploitation_match_set     = automatic_exploitation_run.build_match_set
      automatic_exploitation_match_set.user = automatic_exploitation_run.user
      automatic_exploitation_match_set.runs << automatic_exploitation_run
      automatic_exploitation_match_set.workspace = workspace
      automatic_exploitation_run.match_set = automatic_exploitation_match_set
      automatic_exploitation_run.save!
      automatic_exploitation_run
    end

  end

end